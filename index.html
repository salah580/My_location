<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>موقعي على الخريطة</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
      color: #333;
      text-align: center;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #121212;
      color: #f1f1f1;
    }
    h2 {
      color: #4CAF50;
      margin-top: 20px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #map {
      width: 90%;
      max-width: 800px;
      height: 400px;
      margin: 20px auto;
      border-radius: 12px;
    }
    .location-details, .previous-locations {
      background-color: #fff;
      padding: 20px;
      margin: 20px auto;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
    }
    .dark-mode .location-details, .dark-mode .previous-locations {
      background-color: #1e1e1e;
    }
    .loading {
      font-size: 16px;
      color: #888;
    }
    @media (max-width: 600px) {
      button {
        width: 90%;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h2 id="mainTitle">اضغط على الزر لتحديد موقعك وحفظه</h2>
  <div>
    <button onclick="getLocation()">تحديد الموقع</button>
    <button onclick="toggleDarkMode()">الوضع الداكن</button>
    <button onclick="switchLanguage()">تغيير اللغة</button>
  </div>
  <div id="loading" class="loading"></div>
  <div id="map"></div>
  <div class="location-details" id="location">
    <h3>معلومات الموقع:</h3>
    <p>انتظر لحظة... سيتم عرض إحداثيات الموقع بعد تحديده.</p>
    <button id="shareBtn" style="display:none;" onclick="shareLocation()">مشاركة موقعي</button>
  </div>
  <div class="previous-locations" id="history">
    <h3>المواقع السابقة:</h3>
    <ul id="historyList"></ul>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let language = "ar";
    let map;
    let marker;

    function getLocation() {
      document.getElementById("loading").textContent = language === "ar" ? "جارٍ تحديد الموقع..." : "Locating...";
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        showError({ code: 0 });
      }
    }

    function showPosition(position) {
      const lat = position.coords.latitude.toFixed(5);
      const lon = position.coords.longitude.toFixed(5);
      document.getElementById("loading").textContent = "";

      // Initialize or update map
      if (!map) {
        map = L.map('map').setView([lat, lon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      } else {
        map.setView([lat, lon], 15);
        if (marker) {
          map.removeLayer(marker);
        }
      }

      // Add marker
      marker = L.marker([lat, lon]).addTo(map);

      // Fetch address using OpenCage API
      fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=YOUR_API_KEY&language=${language}`)
        .then(response => response.json())
        .then(data => {
          const address = data.results[0].formatted;
          document.getElementById("location").innerHTML = `
            <h3>${language === "ar" ? "معلومات الموقع:" : "Location Info:"}</h3>
            <p>${language === "ar" ? "خط العرض" : "Latitude"}: ${lat}</p>
            <p>${language === "ar" ? "خط الطول" : "Longitude"}: ${lon}</p>
            <p>${language === "ar" ? "العنوان" : "Address"}: ${address}</p>
            <button onclick="shareLocation()"> ${language === "ar" ? "مشاركة موقعي" : "Share Location"} </button>
          `;
          saveLocationToFile(lat, lon, address);
          storeInHistory(lat, lon, address);
          displayHistory();
        })
        .catch(() => {
          document.getElementById("location").innerHTML = `
            <h3>${language === "ar" ? "معلومات الموقع:" : "Location Info:"}</h3>
            <p>${language === "ar" ? "خط العرض" : "Latitude"}: ${lat}</p>
            <p>${language === "ar" ? "خط الطول" : "Longitude"}: ${lon}</p>
            <p>${language === "ar" ? "العنوان" : "Address"}: غير متوفر</p>
            <button onclick="shareLocation()"> ${language === "ar" ? "مشاركة موقعي" : "Share Location"} </button>
          `;
          saveLocationToFile(lat, lon, "غير متوفر");
          storeInHistory(lat, lon, "غير متوفر");
          displayHistory();
        });
    }

    function saveLocationToFile(lat, lon, address) {
      const now = new Date().toISOString().slice(0,19).replace(/[:T]/g, '-');
      const data = `${language === "ar" ? "موقعك الجغرافي" : "Your Location"}:\n${language === "ar" ? "خط العرض" : "Latitude"}: ${lat}\n${language === "ar" ? "خط الطول" : "Longitude"}: ${lon}\n${language === "ar" ? "العنوان" : "Address"}: ${address}`;
      const blob = new Blob([data], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `موقعي-${now}.txt`;
      link.click();
    }

    function storeInHistory(lat, lon, address) {
      let locations = JSON.parse(localStorage.getItem("locations")) || [];
      const timestamp = new Date().toLocaleString();
      const label = prompt(language === "ar" ? "أدخل اسمًا للموقع:" : "Enter a name for the location:");
      locations.push({ lat, lon, address, label: label || "", time: timestamp });
      localStorage.setItem("locations", JSON.stringify(locations));
    }

    function displayHistory() {
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      const locations = JSON.parse(localStorage.getItem("locations")) || [];
      locations.slice(-5).reverse().forEach(loc => {
        const li = document.createElement("li");
        li.textContent = `${loc.label ? loc.label + " - " : ""}${loc.address} (${loc.time})`;
        li.style.cursor = "pointer";
        li.onclick = () => {
          map.setView([loc.lat, loc.lon], 15);
          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker([loc.lat, loc.lon]).addTo(map);
        };
        list.appendChild(li);
      });
    }

    function shareLocation() {
      const locationDiv = document.getElementById("location");
      const text = locationDiv.innerText;
      if (navigator.share) {
        navigator.share({
          title: language === "ar" ? "موقعي" : "My Location",
          text: text
        });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          alert(language === "ar" ? "تم نسخ الموقع للمشاركة." : "Location copied to clipboard.");
        });
      }
    }

    function showError(error) {
      document.getElementById("loading").textContent = "";
      let message = language === "ar" ? "حدث خطأ في تحديد الموقع." : "Error detecting location.";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = language === "ar" ? "تم رفض الإذن." : "Permission denied.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = language === "ar" ? "الموقع غير متوفر0
